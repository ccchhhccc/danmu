<!DOCTYPE html>
<html>
	<head>
		<meta charset="UTF-8">
		<title></title>
		<link rel="stylesheet" href="../css/style.css">
    	<link rel="stylesheet" href="../css/comment.css">
		<link rel="stylesheet" type="text/css" href="../css/common.css"/>
		<link rel="stylesheet" type="text/css" href="../css/detail.css"/>
		<link rel="stylesheet" type="text/css" href="../css/danmuplayer.css"/>
		<script src="../lib/jquery.js"></script>
		<script src="../lib/danmuplayer.min.js"></script>
		<script src="../lib/jquery.flexText.js"></script>
		<script src="../js/main.js"></script>
	</head>
	<body>
		<!--头部-->
		<div class="header">
			<div class="head">
				<ul>
					<li>首页</li>
					<li>频道</li>
					<li>系列</li>
					<li>专题</li>
					<li>活动</li>
					<li>活动</li>
				</ul>
				<div class="user">
					<a href="http://localhost:2255/html/register.html">注册</a>
					<a href="http://localhost:2255/html/login.html">登录</a>
				</div>
			</div>
		</div>
		
		<!--主体-->
		<div class="main-body">
			<div class="main-title">
				<h3>互帮互助软萌恋爱动画《手太短的鳄鱼》</h3>
				<div class="main-user">
					<span>陈海超</span>
					<span>发布于</span>
					<span>2018-04-08</span>
					<span>频道： 动画</span>
					<div class="star-bg">
						<span class="star" style="width: 0;"></span>
					</div>
					<b>6.8分</b>
				</div>
			</div>
			
			<div class="left">
				<div id="danmup"></div>
			</div>
			<div class="right">
				<!--<div class="brief">
					<h3>简介</h3>
					<p>zhelishijianjiezhelishijianjiezhelishijianjiezhelishijianjiezhelishijianjiezhelishijianjiezhelishijianjiezhelishijianjiezhelishijianjie</p>
				</div>
				<div class="num">
					<img src="../img/nolike.png" />
					<span>222</span>
					<img src="../img/coin.png" />
					<span>233</span>
				</div>
				<div class="grade">
					<h3>评分</h3>
					<span>我的评分</span>
					<div class="star-bg toGetGrade">
						<span class="star" style="width: 0;"></span>
					</div>
					<b>0分</b>
					<a>确定</a>
				</div>-->
			</div>
		</div>
		
		<!--评论区-->
		<div id="pl">
			<div class="commentAll">
			    <!--评论区域 begin-->
			    <div class="reviewArea clearfix">
			        <textarea class="content comment-input" placeholder="Please enter a comment&hellip;" onkeyup="keyUP(this)"></textarea>
			        <a href="javascript:;" class="plBtn">评论</a>
			    </div>
			    <!--评论区域 end-->
			    <!--回复区域 begin-->
			    <div id="chc"></div>
			    <div class="comment-show">
			        <!--<div class="comment-show-con clearfix">
			            <div class="comment-show-con-img pull-left"><img src="images/header-img-comment_03.png" alt=""></div>
			            <div class="comment-show-con-list pull-left clearfix">
			                <div class="pl-text clearfix">
			                    <a href="#" class="comment-size-name">张三 : </a>
			                    <span class="my-pl-con">&nbsp;来啊 造作啊!</span>
			                </div>
			                <div class="date-dz">
			                    <span class="date-dz-left pull-left comment-time">2017-5-2 11:11:39</span>
			                    <div class="date-dz-right pull-right comment-pl-block">
			                        <a href="javascript:;" class="removeBlock">删除</a>
			                        <a href="javascript:;" class="date-dz-pl pl-hf hf-con-block pull-left">回复</a>
			                        
			                    </div>
			                </div>
			                <div class="hf-list-con"></div>
			            </div>
			        </div>-->
			        
			    </div>
			    <!--回复区域 end-->
			</div>
		</div>
		
		<!--footer-->
		<div class="footer">
			<div class="foot">
				<p>重庆理工大学计算机科学与技术学院</p>
				<p>11403080320 陈海超   毕业设计</p>
				<p>支持弹幕的云视频播放平台的设计与实现</p>
			</div>
		</div>
		<!--弹窗-->
		<div id="muhu"></div>
		<div id="layer">
			<i></i>
			<em></em>
			<b></b>
			<h3>登录提示</h3>
			<p>登录后才能发表弹幕评论</p>
			<a id="btn">确定</a>
		</div>
	</body>
</html>
<script src="../js/detail.js"></script>
<script>
//	$(function(){
//		sessionStorage.setItem('videoid',1)
//		$("#danmup").DanmuPlayer({
//		  src:"../video/c.mp4",       //视频源
//		  width:800,			//视频宽度
//		  height:440,			//视频高度
//		  urlToPostDanmu:"http://localhost:2255/danmu/save",
//		 
//		});
//		var dandan = []
//		$.ajax({
//		  	type:"post",
//		  	url:"http://localhost:2255/danmu/id",
//		  	data:{
//		  		id:sessionStorage.getItem('videoid')
//		  	},
//		  	async:false,
//		  	success:function(data){
//		  		console.log(data)
//		  		for(var i = 0 ; i<data.length ; i++){
//		  			dandan[i] = JSON.parse(data[i].danmu)
//		  		}
//		  		
//		  		$("#danmup .danmu-div").danmu("addDanmu",dandan)
//		  	}
//		  });
//		
//	})
</script>
<script>
	$(function(){
		
		var pllist = []
		var hflist = []
		$.ajax({
			type:"post",
			url:"http://localhost:2255/comment/id",
			data:{
				id:1,
			},
			async:false,
			success:function(data){
				pllist = data.data
//				var html = '';
//				for(var i = 0 ;i<data.length ; i++){
//					html += `<div class="comment-show-con clearfix">
//					            <div class="comment-show-con-img pull-left"><img src="${data[i].headurl}" ></div>
//					            <div class="comment-show-con-list pull-left clearfix">
//					                <div class="pl-text clearfix">
//					                    <a href="#" class="comment-size-name">${data[i].name} : </a>
//					                    <span class="my-pl-con">&nbsp;${data[i].content}</span>
//					                </div>
//					                <div class="date-dz">
//					                    <span class="date-dz-left pull-left comment-time">${data[i].time}</span>
//					                    <div class="date-dz-right pull-right comment-pl-block">
//					                        <a href="javascript:;" class="removeBlock">删除</a>
//					                        <a href="javascript:;" class="date-dz-pl pl-hf hf-con-block pull-left">回复</a>
//					                        
//					                    </div>
//					                </div>
//					                <div class="hf-list-con"></div>
//					            </div>
//					        </div>`
//				}
//				$('.comment-show').html(html)
			}
		});
		$.ajax({
			type:"post",
			url:"http://localhost:2255/reply/id",
			data:{
				id:1,
			},
			async:false,
			success:function(data){
				hflist = data.data
			}
		});
		
		var html = ''
		for(var i = 0 ; i<pllist.length ; i++){
			html += `<div class="comment-show-con clearfix"><div class="comment-show-con-img pull-left"><img src="${pllist[i].headurl}" alt=""></div> <div class="comment-show-con-list pull-left clearfix"><div class="pl-text clearfix"> <a href="#" class="comment-size-name" data-id="${pllist[i].userid}" data-plid="${pllist[i].id}">${pllist[i].name} : </a> <span class="my-pl-con">&nbsp;${pllist[i].content}</span> </div> <div class="date-dz"> <span class="date-dz-left pull-left comment-time">${pllist[i].time}</span> <div class="date-dz-right pull-right comment-pl-block"><a href="javascript:;" class="removeBlock">删除</a> <a href="javascript:;" class="date-dz-pl pl-hf pull-left hf-con-block">回复</a></div> </div><div class="hf-list-con" style="display: block;">`
			for(var j = 0 ; j<hflist.length ; j++){
				if(pllist[i].id == hflist[j].plid){
					html += `<div class="all-pl-con"><div class="pl-text hfpl-text clearfix"><a href="#" class="comment-size-name" data-id="${hflist[j].hfuserid}" data-plid="${pllist[i].id}">${hflist[j].hfname} : </a><span class="my-pl-con">回复<a href="#" class="atName" data-id="${hflist[j].pluserid}">@${hflist[j].plname} </a> :  ${hflist[j].hfcontent}</span></div><div class="date-dz"> <span class="date-dz-left pull-left comment-time">${hflist[j].time}</span> <div class="date-dz-right pull-right comment-pl-block"> <a href="javascript:;" class="removeBlock">删除</a> <a href="javascript:;" class="date-dz-pl pl-hf hf-con-block pull-left">回复</a> </div> </div></div>`
				}
			}
			html += `</div></div> </div>`
		}
		
		$('.comment-show').html(html)
	})
</script>
<!--textarea高度自适应-->
<script type="text/javascript">
    $(function () {
        $('.content').flexText();
    });
</script>
<!--textarea限制字数-->
<script type="text/javascript">
    function keyUP(t){
        var len = $(t).val().length;
        if(len > 139){
            $(t).val($(t).val().substring(0,140));
        }
    }
</script>
<!--点击评论创建评论条    创建评论-->
<script type="text/javascript">
    $('.commentAll').on('click','.plBtn',function(){
    	console.log('pinglun')
        var myDate = new Date();
        //获取当前年
        var year=myDate.getFullYear();
        //获取当前月
        var month=myDate.getMonth()+1;
        //获取当前日
        var date=myDate.getDate();
        var h=myDate.getHours();       //获取当前小时数(0-23)
        var m=myDate.getMinutes();     //获取当前分钟数(0-59)
        if(m<10) m = '0' + m;
        var s=myDate.getSeconds();
        if(s<10) s = '0' + s;
        var now=year+'-'+month+"-"+date+" "+h+':'+m+":"+s;
        //获取输入内容
        var oSize = $(this).siblings('.flex-text-wrap').find('.comment-input').val();
        //动态创建评论模块
        oHtml = '<div class="comment-show-con clearfix"><div class="comment-show-con-img pull-left"><img src="images/header-img-comment_03.png" alt=""></div> <div class="comment-show-con-list pull-left clearfix"><div class="pl-text clearfix"> <a href="#" class="comment-size-name">David Beckham : </a> <span class="my-pl-con">&nbsp;'+ oSize +'</span> </div> <div class="date-dz"> <span class="date-dz-left pull-left comment-time">'+now+'</span> <div class="date-dz-right pull-right comment-pl-block"><a href="javascript:;" class="removeBlock">删除</a> <a href="javascript:;" class="date-dz-pl pl-hf hf-con-block pull-left">回复</a>  </div> </div><div class="hf-list-con"></div></div> </div>';
        if(oSize.replace(/(^\s*)|(\s*$)/g, "") != ''){
        	$.ajax({
        		type:"post",
        		url:"http://localhost:2255/comment/add",
        		data:{
        			v_id:1,
        			userid:14,
        			time:now,
        			content:oSize
        		},
        		success:function(data){
        			console.log(data)
        		}
        	});
            $(this).parents('.reviewArea ').siblings('.comment-show').prepend(oHtml);
            $(this).siblings('.flex-text-wrap').find('.comment-input').prop('value','').siblings('pre').find('span').text('');
        }
    });
</script>
<!--点击回复动态创建回复块   创建回复框-->
<script type="text/javascript">
    $('.comment-show').on('click','.pl-hf',function(){
        //获取回复人的名字
        var fhName = $(this).parents('.date-dz-right').parents('.date-dz').siblings('.pl-text').find('.comment-size-name').html();
        //回复@
        var fhN = '回复@'+fhName;
        //var oInput = $(this).parents('.date-dz-right').parents('.date-dz').siblings('.hf-con');
        var fhHtml = '<div class="hf-con pull-left"> <textarea class="content comment-input hf-input" placeholder="" onkeyup="keyUP(this)"></textarea> <a href="javascript:;" class="hf-pl">评论</a></div>';
        //显示回复
        if($(this).is('.hf-con-block')){
            $(this).parents('.date-dz-right').parents('.date-dz').append(fhHtml);
            $(this).removeClass('hf-con-block');
            $('.content').flexText();
            $(this).parents('.date-dz-right').siblings('.hf-con').find('.pre').css('padding','6px 15px');
            //console.log($(this).parents('.date-dz-right').siblings('.hf-con').find('.pre'))
            //input框自动聚焦
            $(this).parents('.date-dz-right').siblings('.hf-con').find('.hf-input').val('').focus().val(fhN);
        }else {
            $(this).addClass('hf-con-block');
            $(this).parents('.date-dz-right').siblings('.hf-con').remove();
        }
    });
</script>
<!--评论回复块创建                 下面的回复-->
<script type="text/javascript">
    $('.comment-show').on('click','.hf-pl',function(){
        var oThis = $(this);
        var myDate = new Date();
        //获取当前年
        var year=myDate.getFullYear();
        //获取当前月
        var month=myDate.getMonth()+1;
        //获取当前日
        var date=myDate.getDate();
        var h=myDate.getHours();       //获取当前小时数(0-23)
        var m=myDate.getMinutes();     //获取当前分钟数(0-59)
        if(m<10) m = '0' + m;
        var s=myDate.getSeconds();
        if(s<10) s = '0' + s;
        var now=year+'-'+month+"-"+date+" "+h+':'+m+":"+s;
        //获取输入内容
        var oHfVal = $(this).siblings('.flex-text-wrap').find('.hf-input').val();
        var oHfName = $(this).parents('.hf-con').parents('.date-dz').siblings('.pl-text').find('.comment-size-name').html();
        var oAllVal = '回复@'+oHfName;
        
        var pluserid = $(this).parents('.hf-con').parents('.date-dz').siblings('.pl-text').find('.comment-size-name').attr('data-id');
        var plid = $(this).parents('.hf-con').parents('.date-dz').siblings('.pl-text').find('.comment-size-name').attr('data-plid');
        
        if(oHfVal.replace(/^ +| +$/g,'') == '' || oHfVal == oAllVal){

        }else {
            $.getJSON("json/pl.json",function(data){
                var oAt = '';
                var oHf = '';
                $.each(data,function(n,v){
                    delete v.hfContent;
                    delete v.atName;
                    var arr;
                    var ohfNameArr;
                    if(oHfVal.indexOf("@") == -1){
                        data['atName'] = '';
                        data['hfContent'] = oHfVal;
                    }else {
                        arr = oHfVal.split(':');
                        ohfNameArr = arr[0].split('@');
                        data['hfContent'] = arr[1];
                        data['atName'] = ohfNameArr[1];
                    }

                    if(data.atName == ''){
                        oAt = data.hfContent;
                    }else {
                        oAt = '回复<a href="#" class="atName">@'+data.atName+'</a> : '+data.hfContent;
                    }
                    oHf = data.hfName;
                    console.log(data.hfContent,'data.hfContent')
                });

                var oHtml = '<div class="all-pl-con"><div class="pl-text hfpl-text clearfix"><a href="#" class="comment-size-name">我的名字 : </a><span class="my-pl-con">'+oAt+'</span></div><div class="date-dz"> <span class="date-dz-left pull-left comment-time">'+now+'</span> <div class="date-dz-right pull-right comment-pl-block"> <a href="javascript:;" class="removeBlock">删除</a> <a href="javascript:;" class="date-dz-pl pl-hf hf-con-block pull-left">回复</a> </div> </div></div>';
                oThis.parents('.hf-con').parents('.comment-show-con-list').find('.hf-list-con').css('display','block').prepend(oHtml) && oThis.parents('.hf-con').siblings('.date-dz-right').find('.pl-hf').addClass('hf-con-block') && oThis.parents('.hf-con').remove();
                
                $.ajax({
                	type:"post",
                	url:"http://localhost:2255/reply/add",
                	data:{
                		plid:plid,
                		hfuserid:13,
                		pluserid:pluserid,
                		hfcontent:data.hfContent,
                		time:now,
                		v_id:1
                	},
                	success:function(data){
                		console.log(data)
                		
                		/*
                			注意一定要改我的名字    加上id   不然会报错的 
                		*/
                	}
                });
            });
        }
    });
</script>
<script>
	$(function(){
		$('.toGetGrade').on('mouseover',function(event){
			var num = (event.offsetX/9).toFixed(1)
			$('.toGetGrade').find('.star').css({'width':event.offsetX})
			$(this).on('mousemove',function(event){
				num = (event.offsetX/9).toFixed(1)
				$('.grade').find('b').html(num+'分')
				$('.toGetGrade').find('.star').css({'width':event.offsetX})
			})
		})
	})
	
</script>